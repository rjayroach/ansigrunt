# '{{ tpl_resource.root_name }}' module (resource wrapper) {{ ansible_managed }}
# module name: {{ tpl_resource.root_name }}
# wrapped resource: {{ tpl_resource.name }}

{% for nvars in [tpl_resource.variables, tpl_resource.env_vars] %}
  {%- for key, value in nvars.iteritems() %}
    {%- if value.type is defined %}{%- set type_string = '{ type = "' +  value.type + '" }' %}{%- endif %}
variable "{{ tpl_resource.root_name_underscore }}_{{ key }}" {{ type_string | default('{}') }}
{% endfor %}{# moving the endfor will effect rendering layout #}
{% endfor %}


{% set pad_length = 40 %}
module "{{ tpl_resource.root_name }}" {
  source {{ ' ' * (pad_length - 7) }} = "{{ tpl_resource.path_to_resource }}"
{% for nvars in [tpl_resource.variables, tpl_resource.env_vars, tpl_resource.external_vars] %}
  {%- for key, value in nvars.iteritems() %}
    {%- set is_list = (value.type is defined and value.type == 'list') %}

  {{ key }}{{ ' ' * (pad_length - (key | length)) }} =
    {%- if key not in tpl_component.provides %}
      {%- if is_list %} [{%- endif %} "${var.{{ tpl_resource.root_name_underscore }}_{{ key }}}"
      {%- if is_list %} ]{%- endif %}
    {%- else %}

      {%- set reference = tpl_component.provides[key] %}
      {%- if is_list %} [{%- endif %}{%- set reference = [reference] %}

      {%- for entry in reference %} "${
        {#- remote state var names reference module output vars as defeind at the end of this file #}
        {%- if entry.provider in tpl_component.needs.remote_states %}data.terraform_remote_state.
        {#- when referencing a module var the name is: module.<module_name>.<module's_wrapped_resource_output_name> #}
        {%- else %}module.{{ tpl_component.lib.dash }}-
        {%- endif %}{{ entry.provider }}.{{ entry.name | default(key) }}}"
        {%- if is_list %},{%- endif %}
      {%- endfor %}

      {%- if is_list %} ]{%- endif %}
    {%- endif %}
  {%- endfor %}
{%- endfor %}

}
{% if (tpl_resource.output_vars | length) > 0 %}

# Output vars are consumed when referenced by a remote_state
# TODO: put an example of the exact string that could be here using the app.dir
# A remote_state is used from outside this component to get the values outputted below
# The output var name is the resource name _ the resource's variable name
# The output value is the module_name . the resource's variable name
{% for key, value in tpl_resource.output_vars.iteritems() %}

# module name: {{ tpl_resource.root_name }}   wrapped resource: {{ tpl_resource.name }}   resource output var name: {{ key }}
output "{{ tpl_resource.name }}_{{ key }}" {
  description = "{{ value.description }}"
  value       = "${module.{{ tpl_resource.root_name }}.{{ key }}}"
}
{% endfor %}
{% endif %}
